<div align="center">
	<p>
		<img alt="Thoughtworks Logo" src="https://raw.githubusercontent.com/ThoughtWorks-DPS/static/master/thoughtworks_flamingo_wave.png?sanitize=true" width=200 /><br />
		<img alt="EMPC Title" src="https://raw.githubusercontent.com/ThoughtWorks-DPS/static/master/EMPCPlatformStarterKitsImage.png?sanitize=true" width=350/><br />
		<h2>lab-gcp-iam-profiles</h2>
		<a href="https://opensource.org/licenses/MIT"><img src="https://img.shields.io/github/license/ThoughtWorks-DPS/psk-gcp-iam-profiles"></a> <a href="https://console.cloud.google.com"><img src="https://img.shields.io/badge/-deployed-blank.svg?style=social&logo=googlecloud"></a>
	</p>
</div>

## maintainers notes

### Initial Setup
Unlike any other pipelines, this terraform configuration must have an initial run performed with administrative credentials to all PSK GCP projects.  Once the IAM SA is created in all projects it will be able to run autonomously going forward.

### architecture  

_enable_gcp_apis.tf_

This configuration will enable any GCP Service APIs needed by the PSK.  If a new resource type is needed by the PSK it should be added here.

_psk-gcp-platform-base-sa.tf_  

This configuration is applied in each project defined for the PSK lifecycle, but could be applied only to a central account if cross-project service account token creation for the PSK is allowed by the organization (it is assumed here it is not).

_Roles_  

By convention, a unique service account is created to match each infrastructure pipeline. A separate terrform file is created for each sa, named to match the github repository of the pipeline that uses the role.  

The platform GCP Service Accounts are named generally after the code repository of the pipeline for which they are created and follow a sort of camel case naming convention, but are prefixed with `psk` and end in `sa`.  

Ex: the role for the psk-gcp-iam-profiles pipeline is named `psk-gcp-iam-profiles-sa`. See the other existing roles for guideance.  

When creating a new role, be sure to create the related `roles` inspec test for integration testing.  

_terraform modules_  

Uses the following GCP official terraform modules: (check for updates)  

terraform-google-modules/iam/google//modules/custom_role_iam

_integration tests_  

The post-run integration tests are limited to testing for the existence of the named role, and that the role has the correct service account attached. We do not check the details of the individual permission statements. This is because such a test would involve duplicating a long list of permission settings (basically the same as defined within the role) and then comparing that against the same list in the actual declarative policy file. It is the terraform api that is actually making the configuration change so if is succeeds at all that means it has successfully applied what is defined in the role definition. Therefore checking a list of permissions we write ourselves in one file against another list of the same permissions we separately type into another file is actually more likely to result in multiple false-postives then simply using the role in the dependent pipeline and adjusting for failures from there.  

_credential rotation_  

Presently, a scheduled pipeline is configured to run once per week. This pipeline will perform a two-key rotation pattern and then run the integration tests. The effect of which is that PSK infrastructure service account credentials are fully rotated every two weeks.  

### local engineering practice additions or notes (See lab-documentation for standard practices and ADRs)  

1. specific .gitignore entries

* Ignore all extensions of .auto.tfvars.json. These are autogenerated during the pipeline run and are ignored so that any local testing doesn't accidently cause problem to the pipeline.
* Ignore gcp-creds.json.  This is autogenerated during the pipeline run from retrieved secrets in the secret vault and used to log into the PSK Base SA during execution.  

1. additional pre-commit checks, these checks also done in the pipeline

* [tflint](https://github.com/terraform-linters/tflint)
* [tfsec](https://github.com/aquasecurity/tfsec)
* terraform fmt
* terraform validate
* [checkov](https://github.com/bridgecrewio/checkov)
